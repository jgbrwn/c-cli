<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
  <title>CineCLI Web</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 20px; }
    h1 span { font-size: 0.5em; color: #888; }
    
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    #sourceSelect {
      padding: 12px;
      font-size: 14px;
      border: 2px solid #333;
      border-radius: 8px;
      background: #16213e;
      color: #fff;
      cursor: pointer;
    }
    input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #333;
      border-radius: 8px;
      background: #16213e;
      color: #fff;
      outline: none;
    }
    input[type="text"]:focus { border-color: #e94560; }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: #e94560;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #ff6b6b; }
    button:disabled { background: #555; cursor: not-allowed; }
    
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { background: #ff4444; padding: 12px; border-radius: 8px; margin: 10px 0; }
    .success { background: #44aa44; padding: 12px; border-radius: 8px; margin: 10px 0; }
    
    .movies { display: grid; gap: 12px; }
    .movie {
      background: #16213e;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .movie:hover { background: #1f3460; }
    .movie-thumb {
      width: 45px;
      height: 67px;
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .movie-thumb-placeholder {
      width: 45px;
      height: 67px;
      background: #0f1729;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }
    .movie-info { flex: 1; }
    .movie-info h3 { margin: 0 0 4px 0; color: #fff; font-size: 16px; }
    .movie-info span { color: #888; font-size: 14px; }
    .movie-rating { color: #ffd700; font-weight: bold; flex-shrink: 0; }
    .type-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
    .type-tag.series { background: #3498db; color: white; }
    .type-tag.episode { background: #9b59b6; color: white; }
    
    .movie-details {
      background: #16213e;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .movie-header {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    .movie-poster {
      width: 150px;
      border-radius: 8px;
      flex-shrink: 0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .movie-poster:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
      cursor: pointer;
    }
    .movie-info-main { flex: 1; }
    .movie-details h2 { margin: 0 0 10px 0; color: #e94560; }
    .movie-meta { color: #888; margin-bottom: 10px; }
    .movie-meta span { margin-right: 15px; }
    .movie-genres { color: #4ecdc4; margin-bottom: 8px; }
    .movie-crew { color: #888; font-size: 14px; margin-bottom: 4px; }
    .movie-desc { line-height: 1.6; color: #ccc; }
    
    .torrents { margin-top: 20px; }
    .torrents h3 { color: #e94560; margin-bottom: 10px; }
    .torrent {
      background: #0f1729;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .torrent-info { display: flex; gap: 20px; flex-wrap: wrap; }
    .torrent-info span { color: #888; }
    .torrent-info .quality { color: #4ecdc4; font-weight: bold; }
    .torrent-info .seeds { color: #44aa44; }
    .torrent-info .peers { color: #ffaa00; }
    .torrent-actions { display: flex; gap: 8px; }
    .torrent-actions button { padding: 8px 12px; font-size: 14px; }
    .btn-magnet { background: #9b59b6; }
    .btn-magnet:hover { background: #a66bbe; }
    .btn-server { background: #3498db; }
    .btn-server:hover { background: #5dade2; }
    .btn-client { background: #27ae60; }
    .btn-client:hover { background: #2ecc71; }
    
    .back-btn {
      background: #555;
      margin-bottom: 15px;
    }
    .back-btn:hover { background: #666; }
    
    .magnet-display {
      background: #0f1729;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
      color: #888;
    }
    .copy-btn {
      background: #555;
      padding: 6px 12px;
      font-size: 12px;
      margin-top: 8px;
    }
    
    /* Status messages */
    .status-msg {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
    }
    .status-msg.loading {
      background: #2c3e50;
      color: #f39c12;
    }
    .status-msg.success {
      background: #1e4620;
      color: #4ade80;
    }
    .status-msg.error {
      background: #4a1515;
      color: #f87171;
    }
    
    /* Pagination styles */
    .pagination-info {
      color: #888;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding: 15px 0;
    }
    .page-btn {
      background: #3498db;
      padding: 10px 20px;
    }
    .page-btn:hover {
      background: #5dade2;
    }
    .page-numbers {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .page-num {
      background: #16213e;
      padding: 8px 14px;
      min-width: 40px;
      border: 1px solid #333;
    }
    .page-num:hover {
      background: #1f3460;
    }
    .page-num.active {
      background: #e94560;
      border-color: #e94560;
      cursor: default;
    }
    .page-ellipsis {
      color: #888;
      padding: 0 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé¨ CineCLI <span>Web</span></h1>
    
    <div class="search-box">
      <select id="sourceSelect">
        <option value="yts">YTS (Movies)</option>
        <option value="torrents-csv">Torrents-CSV (All)</option>
      </select>
      <input type="text" id="searchInput" placeholder="Search for movies or TV shows..." autofocus>
      <button onclick="search()" id="searchBtn">Search</button>
    </div>
    
    <div id="content"></div>
  </div>

  <script>
    const content = document.getElementById('content');
    const searchInput = document.getElementById('searchInput');
    
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') search();
    });
    
    // Global state for pagination
    let currentPage = 1;
    let currentQuery = '';
    let currentSource = 'yts';
    
    async function search(page = 1) {
      const query = searchInput.value.trim();
      if (!query) return;
      
      currentQuery = query;
      currentSource = document.getElementById('sourceSelect').value;
      currentPage = page;
      
      content.innerHTML = '<div class="loading">Searching...</div>';
      
      try {
        const resp = await fetch(`/api/search?q=${encodeURIComponent(query)}&source=${currentSource}&page=${page}&per_page=20`);
        const data = await resp.json();
        
        if (!resp.ok) {
          content.innerHTML = `<div class="error">${data?.error || 'Search failed'}</div>`;
          return;
        }
        
        // Handle paginated response
        const results = data.results || data;
        const pagination = data.total ? data : null;
        
        if (!results || results.length === 0) {
          content.innerHTML = '<div class="error">No results found</div>';
          return;
        }
        
        let html = '';
        
        // Pagination header
        if (pagination) {
          html += `<div class="pagination-info">Showing ${(pagination.page - 1) * pagination.per_page + 1}-${Math.min(pagination.page * pagination.per_page, pagination.total)} of ${pagination.total} results</div>`;
        }
        
        html += '<div class="movies">';
        
        if (currentSource === 'yts') {
          html += results.map(m => `
            <div class="movie" onclick="showMovie(${m.id})">
              ${m.small_cover_image ? `<img class="movie-thumb" src="${m.small_cover_image}" alt="">` : '<div class="movie-thumb-placeholder">üé¨</div>'}
              <div class="movie-info">
                <h3>${escapeHtml(m.title)}</h3>
                <span>${m.year || ''}${m.runtime ? ` ‚Ä¢ ${m.runtime} min` : ''}</span>
              </div>
              ${m.rating ? `<div class="movie-rating">‚≠ê ${m.rating}</div>` : ''}
            </div>
          `).join('');
        } else {
          // Torrents-CSV format
          html += results.map(m => {
            const isSeries = m.omdb?.Type === 'series';
            const isEpisode = m.omdb?.Type === 'episode';
            const isTVContent = isSeries || isEpisode;
            const placeholder = isTVContent ? 'üì∫' : 'üé¨';
            const typeTag = isSeries ? '<span class="type-tag series">üì∫ Series</span>' : (isEpisode ? '<span class="type-tag episode">üì∫ Episode</span>' : '');
            return `
            <div class="movie" onclick="showTorrent('${m.id}', '${escapeJs(m.title)}', '${m.size}', ${m.seeders || 0}, ${m.leechers || 0}, '${m.imdb_code || ''}')">
              ${m.omdb?.Poster && m.omdb.Poster !== 'N/A' ? `<img class="movie-thumb" src="${m.omdb.Poster}" alt="">` : `<div class="movie-thumb-placeholder">${placeholder}</div>`}
              <div class="movie-info">
                <h3>${escapeHtml(m.title)} ${typeTag}</h3>
                <span>${m.year || ''} ‚Ä¢ ${m.size} ‚Ä¢ ‚¨Ü${m.seeders || 0} ‚¨á${m.leechers || 0}${m.omdb?.totalSeasons ? ` ‚Ä¢ ${m.omdb.totalSeasons} seasons` : ''}</span>
              </div>
              ${m.omdb?.imdbRating && m.omdb.imdbRating !== 'N/A' ? `<div class="movie-rating">‚≠ê ${m.omdb.imdbRating}</div>` : ''}
            </div>
          `}).join('');
        }
        
        html += '</div>';
        
        // Pagination controls
        if (pagination && pagination.total_pages > 1) {
          html += '<div class="pagination">';
          
          // Previous button
          if (pagination.page > 1) {
            html += `<button onclick="search(${pagination.page - 1})" class="page-btn">‚Üê Previous</button>`;
          }
          
          // Page numbers
          html += '<span class="page-numbers">';
          const startPage = Math.max(1, pagination.page - 2);
          const endPage = Math.min(pagination.total_pages, pagination.page + 2);
          
          if (startPage > 1) {
            html += `<button onclick="search(1)" class="page-num">1</button>`;
            if (startPage > 2) html += '<span class="page-ellipsis">...</span>';
          }
          
          for (let i = startPage; i <= endPage; i++) {
            if (i === pagination.page) {
              html += `<button class="page-num active">${i}</button>`;
            } else {
              html += `<button onclick="search(${i})" class="page-num">${i}</button>`;
            }
          }
          
          if (endPage < pagination.total_pages) {
            if (endPage < pagination.total_pages - 1) html += '<span class="page-ellipsis">...</span>';
            html += `<button onclick="search(${pagination.total_pages})" class="page-num">${pagination.total_pages}</button>`;
          }
          html += '</span>';
          
          // Next button
          if (pagination.page < pagination.total_pages) {
            html += `<button onclick="search(${pagination.page + 1})" class="page-btn">Next ‚Üí</button>`;
          }
          
          html += '</div>';
        }
        
        content.innerHTML = html;
      } catch (err) {
        content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
      }
    }
    
    async function showMovie(id) {
      content.innerHTML = '<div class="loading">Loading movie details...</div>';
      
      try {
        const resp = await fetch(`/api/movie/${id}`);
        const movie = await resp.json();
        
        if (movie.error) {
          content.innerHTML = `<div class="error">${movie.error}</div>`;
          return;
        }
        
        const omdb = movie.omdb;
        const genres = omdb?.Genre || ((movie.genres && movie.genres.length) ? movie.genres.join(', ') : null);
        const desc = omdb?.Plot || movie.summary || movie.description_full || 'No description available.';
        const rating = omdb?.imdbRating || movie.rating || null;
        const runtime = omdb?.Runtime?.replace(' min', '') || movie.runtime || null;
        const director = omdb?.Director || null;
        const actors = omdb?.Actors || null;
        const poster = (omdb?.Poster && omdb.Poster !== 'N/A') ? omdb.Poster : (movie.large_cover_image || movie.medium_cover_image || null);
        const rated = omdb?.Rated && omdb.Rated !== 'N/A' ? omdb.Rated : null;
        
        let torrentsHtml = '';
        if (movie.torrents && movie.torrents.length > 0) {
          torrentsHtml = `
            <div class="torrents">
              <h3>üß≤ Available Torrents</h3>
              ${movie.torrents.map((t, i) => `
                <div class="torrent" id="torrent-${i}">
                  <div class="torrent-info">
                    <span class="quality">${t.quality}</span>
                    <span>${t.size}</span>
                    <span class="seeds">‚¨Ü ${t.seeds} seeds</span>
                    <span class="peers">‚¨á ${t.peers} peers</span>
                  </div>
                  <div class="torrent-actions">
                    <button class="btn-magnet" onclick="showMagnet('${t.hash}', '${escapeJs(movie.title)} ${t.quality}', ${i})">Magnet</button>
                    <button class="btn-server" onclick="downloadToServer('${escapeJs(t.url)}', '${escapeJs(movie.title)}', '${t.quality}', ${i})">‚¨á Server</button>
                    <button class="btn-client" onclick="downloadToClient('${escapeJs(t.url)}', '${escapeJs(movie.title)}', '${t.quality}')">üíæ Save</button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }
        
        content.innerHTML = `
          <button class="back-btn" onclick="search()">‚Üê Back to results</button>
          <div class="movie-details">
            <div class="movie-header">
              ${poster ? `<a href="https://www.imdb.com/title/${movie.imdb_code}" target="_blank" rel="noopener" title="View on IMDB"><img class="movie-poster" src="${poster}" alt="${escapeHtml(movie.title)}"></a>` : ''}
              <div class="movie-info-main">
                <h2>${escapeHtml(movie.title)} (${movie.year})</h2>
                <div class="movie-meta">
                  ${rating ? `<span>‚≠ê ${rating}</span>` : ''}
                  ${runtime ? `<span>‚è± ${runtime} min</span>` : ''}
                  ${rated ? `<span>üé´ ${rated}</span>` : ''}
                </div>
                ${genres ? `<div class="movie-genres">üé≠ ${genres}</div>` : ''}
                ${director ? `<div class="movie-crew">üé¨ Director: ${escapeHtml(director)}</div>` : ''}
                ${actors ? `<div class="movie-crew">üé≠ Cast: ${escapeHtml(actors)}</div>` : ''}
              </div>
            </div>
            <div class="movie-desc">${escapeHtml(desc)}</div>
            ${torrentsHtml}
          </div>
        `;
      } catch (err) {
        content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
      }
    }
    
    async function showMagnet(hash, name, idx) {
      try {
        const resp = await fetch(`/api/magnet?hash=${hash}&name=${encodeURIComponent(name)}`);
        const data = await resp.json();
        
        const container = document.getElementById(`torrent-${idx}`);
        // Remove any existing magnet display
        const existing = container.querySelector('.magnet-display');
        if (existing) existing.remove();
        
        const magnetDiv = document.createElement('div');
        magnetDiv.className = 'magnet-display';
        magnetDiv.innerHTML = `
          ${data.magnet}
          <br><button class="copy-btn" onclick="copyMagnet(this, '${escapeJs(data.magnet)}')">Copy to clipboard</button>
        `;
        container.appendChild(magnetDiv);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
    
    function copyMagnet(btn, magnet) {
      navigator.clipboard.writeText(magnet).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy to clipboard', 2000);
      });
    }
    
    async function downloadToServer(url, title, quality, idx) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      try {
        const resp = await fetch(`/api/download?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&quality=${quality}`);
        const data = await resp.json();
        
        if (data.error) {
          alert('Error: ' + data.error);
          btn.textContent = '‚¨á Server';
          btn.disabled = false;
          return;
        }
        
        btn.textContent = '‚úì Saved';
        btn.style.background = '#44aa44';
        
        // Show success message
        const container = document.getElementById(`torrent-${idx}`);
        const existing = container.querySelector('.success');
        if (existing) existing.remove();
        
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = `Saved to server: ${data.filepath}`;
        container.appendChild(successDiv);
      } catch (err) {
        alert('Error: ' + err.message);
        btn.textContent = '‚¨á Server';
        btn.disabled = false;
      }
    }
    
    function downloadToClient(url, title, quality) {
      const link = document.createElement('a');
      link.href = `/api/download-file?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&quality=${quality}`;
      link.download = '';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    async function downloadTorrentToClient(infohash, title) {
      const btn = event.target;
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'Fetching...';
      
      const container = document.getElementById('torrent-0');
      
      // Remove any existing status messages
      const existingStatus = container?.querySelector('.status-msg');
      if (existingStatus) existingStatus.remove();
      
      // Show loading status
      let statusDiv = null;
      if (container) {
        statusDiv = document.createElement('div');
        statusDiv.className = 'status-msg loading';
        statusDiv.innerHTML = '‚è≥ Fetching .torrent from cache services...';
        container.appendChild(statusDiv);
      }
      
      try {
        const resp = await fetch(`/api/download-torrent?infohash=${encodeURIComponent(infohash)}&title=${encodeURIComponent(title)}`);
        
        if (!resp.ok) {
          throw new Error('Failed to fetch torrent');
        }
        
        // Get filename from Content-Disposition header
        const disposition = resp.headers.get('Content-Disposition');
        let filename = `${title.replace(/[^a-zA-Z0-9]/g, '_')}.torrent`;
        if (disposition) {
          const match = disposition.match(/filename="(.+)"/);
          if (match) filename = match[1];
        }
        
        // Determine file type from Content-Type
        const contentType = resp.headers.get('Content-Type');
        const isTorrent = contentType?.includes('bittorrent');
        
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        btn.textContent = '‚úì Saved';
        btn.style.background = '#44aa44';
        
        if (statusDiv) {
          const fileType = isTorrent ? '.torrent file' : '.magnet file (cache unavailable)';
          statusDiv.className = 'status-msg success';
          statusDiv.textContent = `‚úì Downloaded ${fileType}`;
        }
      } catch (err) {
        if (statusDiv) {
          statusDiv.className = 'status-msg error';
          statusDiv.textContent = `Error: ${err.message}`;
        }
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    function escapeJs(text) {
      return (text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }
    
    async function showTorrent(infohash, title, size, seeders, leechers, imdbCode) {
      content.innerHTML = '<div class="loading">Loading details...</div>';
      
      // Fetch OMDB data
      let omdb = null;
      try {
        let omdbUrl = imdbCode 
          ? `/api/omdb?i=${encodeURIComponent(imdbCode)}`
          : `/api/omdb?t=${encodeURIComponent(title)}`;
        const resp = await fetch(omdbUrl);
        const data = await resp.json();
        if (data && data.Title) {
          omdb = data;
          if (!imdbCode && data.imdbID) {
            imdbCode = data.imdbID;
          }
        }
      } catch (e) {
        console.log('OMDB lookup failed:', e);
      }
      
      // Determine if it's a TV show
      const isSeries = omdb?.Type === 'series';
      const isEpisode = omdb?.Type === 'episode';
      const isTVContent = isSeries || isEpisode;
      
      // Build metadata display
      const rating = omdb?.imdbRating && omdb.imdbRating !== 'N/A' ? omdb.imdbRating : null;
      const runtime = omdb?.Runtime && omdb.Runtime !== 'N/A' ? omdb.Runtime : null;
      const rated = omdb?.Rated && omdb.Rated !== 'N/A' ? omdb.Rated : null;
      const genres = omdb?.Genre && omdb.Genre !== 'N/A' ? omdb.Genre : null;
      const year = omdb?.Year || null;
      const totalSeasons = omdb?.totalSeasons || null;
      const director = omdb?.Director && omdb.Director !== 'N/A' ? omdb.Director : null;
      const writer = omdb?.Writer && omdb.Writer !== 'N/A' ? omdb.Writer : null;
      const actors = omdb?.Actors && omdb.Actors !== 'N/A' ? omdb.Actors : null;
      const plot = omdb?.Plot && omdb.Plot !== 'N/A' ? omdb.Plot : null;
      const poster = omdb?.Poster && omdb.Poster !== 'N/A' ? omdb.Poster : null;
      
      // Type badge
      const typeBadge = isSeries ? 'üì∫ TV Series' : (isEpisode ? 'üì∫ Episode' : 'üé¨ Movie');
      
      content.innerHTML = `
        <button class="back-btn" onclick="search()">‚Üê Back to results</button>
        <div class="movie-details">
          <div class="movie-header">
            ${poster ? `<a href="https://www.imdb.com/title/${imdbCode}" target="_blank" rel="noopener" title="View on IMDB"><img class="movie-poster" src="${poster}" alt="${escapeHtml(omdb?.Title || title)}"></a>` : ''}
            <div class="movie-info-main">
              <h2>${escapeHtml(omdb?.Title || title)}${year ? ` (${year})` : ''}</h2>
              <div class="movie-meta">
                <span>${typeBadge}</span>
                ${rating ? `<span>‚≠ê ${rating}</span>` : ''}
                ${runtime ? `<span>‚è± ${runtime}</span>` : ''}
                ${rated ? `<span>üé´ ${rated}</span>` : ''}
                ${totalSeasons ? `<span>üìÖ ${totalSeasons} seasons</span>` : ''}
              </div>
              ${genres ? `<div class="movie-genres">üé≠ ${genres}</div>` : ''}
              ${isTVContent && writer ? `<div class="movie-crew">‚úçÔ∏è Creator: ${escapeHtml(writer)}</div>` : ''}
              ${!isTVContent && director ? `<div class="movie-crew">üé¨ Director: ${escapeHtml(director)}</div>` : ''}
              ${actors ? `<div class="movie-crew">üé≠ Cast: ${escapeHtml(actors)}</div>` : ''}
              ${imdbCode ? `<div class="movie-crew"><a href="https://www.imdb.com/title/${imdbCode}" target="_blank" style="color: #e94560;">üîó View on IMDB</a></div>` : ''}
            </div>
          </div>
          ${plot ? `<div class="movie-desc">${escapeHtml(plot)}</div>` : ''}
          <div class="torrents">
            <h3>üß≤ Download Options</h3>
            <div class="torrent" id="torrent-0">
              <div class="torrent-info">
                <span class="quality">Full</span>
                <span>üíæ ${size}</span>
                <span class="seeds">‚¨Ü ${seeders}</span>
                <span class="peers">‚¨á ${leechers}</span>
              </div>
              <div class="torrent-actions">
                <button class="btn-magnet" onclick="showMagnetDirect('${infohash}', '${escapeJs(title)}', 0)">Magnet</button>
                <button class="btn-server" onclick="downloadToServerDirect('${infohash}', '${escapeJs(title)}', 0)">‚¨á Server</button>
                <button class="btn-client" onclick="downloadTorrentToClient('${infohash}', '${escapeJs(title)}')">üíæ Save</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    function showMagnetDirect(infohash, title, idx) {
      const magnet = `magnet:?xt=urn:btih:${infohash}&dn=${encodeURIComponent(title)}&tr=udp://open.demonii.com:1337/announce&tr=udp://tracker.openbittorrent.com:80/announce&tr=udp://tracker.opentrackr.org:1337/announce`;
      
      const container = document.getElementById(`torrent-${idx}`);
      const existing = container.querySelector('.magnet-display');
      if (existing) existing.remove();
      
      const magnetDiv = document.createElement('div');
      magnetDiv.className = 'magnet-display';
      magnetDiv.innerHTML = `
        ${magnet}
        <br><button class="copy-btn" onclick="copyMagnet(this, '${magnet.replace(/'/g, "\\'")}')">Copy to clipboard</button>
      `;
      container.appendChild(magnetDiv);
    }
    
    async function downloadToServerDirect(infohash, title, idx) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      const container = document.getElementById(`torrent-${idx}`);
      
      // Remove any existing status messages
      const existingStatus = container.querySelector('.status-msg');
      if (existingStatus) existingStatus.remove();
      
      // Show loading status
      const statusDiv = document.createElement('div');
      statusDiv.className = 'status-msg loading';
      statusDiv.innerHTML = '‚è≥ Fetching .torrent from cache services...';
      container.appendChild(statusDiv);
      
      try {
        const resp = await fetch(`/api/save-magnet?infohash=${infohash}&title=${encodeURIComponent(title)}`);
        const data = await resp.json();
        
        if (data.error) {
          statusDiv.className = 'status-msg error';
          statusDiv.textContent = `Error: ${data.error}`;
          btn.textContent = '‚¨á Server';
          btn.disabled = false;
          return;
        }
        
        btn.textContent = '‚úì Saved';
        btn.style.background = '#44aa44';
        
        // Show success with file type info
        const fileType = data.type === 'torrent' ? '.torrent file' : '.magnet file (cache unavailable)';
        statusDiv.className = 'status-msg success';
        statusDiv.textContent = `‚úì Saved ${fileType}: ${data.filepath}`;
      } catch (err) {
        statusDiv.className = 'status-msg error';
        statusDiv.textContent = `Error: ${err.message}`;
        btn.textContent = '‚¨á Server';
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
